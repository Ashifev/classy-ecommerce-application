try {
    const productId = req.params.id;
    const product = await productDb.findById(productId);
    if (!product) {
        return res.status(404).render('404');
    }

    const { name, price, description, category, brand, discountAmount, stockQuantity, deletedImages, editedImages } = req.body;

    product.name = name;
    product.price = price;
    product.description = description;
    product.category = category;
    product.brand = brand;
    product.discountAmount = discountAmount;
    product.stockQuantity = stockQuantity;

    // Create a new array to store updated images
    let updatedImages = [...product.image];

    // Handle deleted images
    if (deletedImages) {
        const deletedIndices = JSON.parse(deletedImages);
        const imagesToDelete = product.image.filter((_, index) => deletedIndices.includes(index));

        // Delete files from the server
        imagesToDelete.forEach(imagePath => {
            const fullPath = path.join(__dirname, '..', 'public', imagePath);
            fs.unlink(fullPath, (err) => {
                if (err) console.error("Error deleting image file:", err);
            });
        });

        // Remove deleted images from the array
        updatedImages = updatedImages.filter((_, index) => !deletedIndices.includes(index));
    }

    // Handle edited images
    if (editedImages) {
        const editedImageData = JSON.parse(editedImages);
        editedImageData.forEach(item => {
            if (item.index < updatedImages.length) {
                if (updatedImages[item.index] !== item.path) {
                    const oldImagePath = updatedImages[item.index];
                    const fullPath = path.join(__dirname, '..', 'public', oldImagePath);
                    fs.unlink(fullPath, (err) => {
                        if (err) console.error("Error deleting old edited image file:", err);
                    });

                    updatedImages[item.index] = item.path;
                }
            }
        });
    }

    if (req.files && req.files.newImages) {
        const newImagePaths = req.files.newImages.map(file => `/uploads/products/${file.filename}`);
        updatedImages = updatedImages.concat(newImagePaths);
    }

    product.image = updatedImages;

    await product.save();
    res.redirect('/admin/products');
} catch (error) {
    console.error("Error updating product", error);
    return res.status(500).render('500');
}